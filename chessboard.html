<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="Styles/styles.css">
    <title></title>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <table class="table table-bordered col-12 col-md-8 col-lg-4" id="board"></table>
      </div>
      <span id="result"></span>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="ChessLogic.js"></script>
    <script>
    function setupBoardGUI() {
      let board = '';
      for (let i = 7; i >= 0; i--) {
        board += '<tr class="d-flex">';
        for (let j = 0; j < 8; j++) {
          board += `<td class="square" data-row="${i}" data-col="${j}" onclick="squareClicked(this)"></td>`;
        }
        board += "</tr>";
      }
      $('#board').html(board);
      $('.square').each(function(){
        $(this).css("height", $(this).css("width"));
      });
    }
    function updateBoardGUI() {
      let boardLength = 8;
      game.print();
      for (let i = boardLength - 1; i >= 0; i--) {
        for (let j = 0; j < boardLength; j++) {
          let cell;
          $.post('http://localhost:3000/getPiece', {row: i, col: j}, (data) => {
            cell = data;
          });
          let square = $(`[data-row='${i}'][data-col='${j}']`);
          square.empty();
          if (cell !== null) {
            let colour = (cell.colour === WHITE ? "white" : "black");
            let piece = `<div class="piece ${colour} ${cell.constructor.name}" data-colour="${colour}" data-type="${cell.constructor.name}" onclick="pieceClicked(this)"></div>`
            square.append(piece);
          }
        }
      }
    }
    let isUserMove = false;
    let origin = null;
    function squareClicked(identifier) {
      let row = $(identifier).data('row');
      let col = $(identifier).data('col');
      if (origin !== null) {
        if (pieceType === "King") {
          if (col - origin.col === 2) {
            executeMove(KINGSIDE);
          } else if (origin.col - col === 2) {
            executeMove(QUEENSIDE);
          }
        } else {
          executeMove({from: origin, to: {row: row, col: col}});
        }
        origin = null;
        pieceType = null;
        pieceColour = null;
        isUserMove = false;
      } else {
        origin = {row: row, col: col};
      }
    }
    let pieceType = null;
    function pieceClicked(identifier) {
      if (pieceType === null) {
        pieceType = $(identifier).data('type');
      }
    }
    class HumanPlayer {
      constructor(colour) {
        this.colour = colour;
      }
      async selectMove() {
        isUserMove = true;
        console.log("Waiting for user to input move");
      }
    }
    class ComputerPlayer {
      constructor(colour) {
        this.colour = colour;
      }
      async selectMove() {
        $.post('http://localhost:3000/selectMove', (data) => {
          executeMove(move);
        });
      }
    }
    </script>
    <script>
    function wait(ms) {
      return new Promise(r => setTimeout(r, ms));
    }
    let colour = WHITE;
    setupBoardGUI();
    updateBoardGUI();
    let players = [new HumanPlayer(WHITE), new ComputerPlayer(BLACK)];
    let index = 0;
    players[index].selectMove();

    async function executeMove (move) {
      let result;
      $.post('http://localhost:3000/executeMove', move, (data) => { result = data; });
      if (error instanceof InvalidMoveError) {
        players[index].selectMove();
        return;
      }
      await updateBoardGUI();
      await wait(1000);
      $('#result').html(result);
      index = (index + 1) % 2;
      players[index].selectMove();
    }
    </script>
  </body>
</html>
